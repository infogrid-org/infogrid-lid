<?xml version="1.0" encoding="UTF-8"?>
<!--
    This file is part of InfoGrid(tm). You may not use this file except in
    compliance with the InfoGrid license. The InfoGrid license and important
    disclaimers are contained in the file LICENSE.InfoGrid.txt that you should
    have received with InfoGrid. If you have not received LICENSE.InfoGrid.txt
    or you do not consent to all aspects of the license and the disclaimers,
    no license is granted; do not use this file.
 
    For more information about InfoGrid go to http://infogrid.org/

    Copyright 1998-2010 by R-Objects Inc. dba NetMesh Inc., Johannes Ernst
    All rights reserved.
-->

<!DOCTYPE model PUBLIC '-//InfoGrid.org//InfoGrid Model//EN' 'http://infogrid.org/dtds/model.dtd'>
<model>
    <subjectarea ID="org.infogrid.lid.model.lid">
        <name>org.infogrid.lid.model.lid</name>
        <username>LID Subject Area</username>
        <userdescription>The concepts defined by LID that aren't defined anywhere else.</userdescription>

        <dependson>
            <subjectareareference>
                <name>org.infogrid.lid.model.yadis</name>
            </subjectareareference>
            <subjectareareference>
                <name>org.infogrid.model.Web</name>
            </subjectareareference>
            <modulereference>
                <name>org.infogrid.lid</name>
            </modulereference>
        </dependson>

        <entitytype ID="org.infogrid.lid.model.lid/AuthenticationService">
            <name>AuthenticationService</name>
            <userdescription>A Yadis Service that is able to authenticate a principal. More specific subclasses
are provided for specific authentication protocols.</userdescription>
            <supertype>org.infogrid.lid.model.yadis/XrdsService</supertype>
            <isabstract/>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/WebAuthenticationService">
            <name>WebAuthenticationService</name>
            <userdescription>An AuthenticationService that uses a standard web browser as the client device,
and thus implements the redirect dance. More specific subclasses
are provided for specific authentication protocols.</userdescription>
            <supertype>org.infogrid.lid.model.lid/AuthenticationService</supertype>
            <isabstract/>
            <additionalinterface>org.infogrid.lid.LidAuthenticationService</additionalinterface>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/LidGpgSso">
            <name>LidGpgSso</name>
            <username>LID's GPG-based Authentication Service</username>
            <userdescription>This represents a LID GPG-based Authentication Service in any version.</userdescription>
            <supertype>org.infogrid.lid.model.lid/WebAuthenticationService</supertype>
            <isabstract/>
            <synonym>http://lid.netmesh.org/sso</synonym>
        </entitytype>        

        <entitytype ID="org.infogrid.lid.model.lid/LidGpgSso2">
            <name>LidGpgSso2</name>
            <username>LID's GPG-based Authentication Service (version 2)</username>
            <userdescription>An Authentication Service based on the LID GPG SSO service, version 2.</userdescription>
            <supertype>org.infogrid.lid.model.lid/LidGpgSso</supertype>
            <implementsMethod><![CDATA[
    public String determineRedirectUrl(
            String                            clientIdentifier,
            String                            returnToUrl,
            String                            realm,
            org.infogrid.util.context.Context context )
        throws
            org.infogrid.util.FactoryException
    {
        org.infogrid.mesh.set.OrderedMeshObjectSet endpoints
                = org.infogrid.lid.model.yadis.util.YadisUtil.determineOrderedEndpointWebResources( the_Delegate );
        if( endpoints.isEmpty() ) {
            return null;
        }
        MeshObject selectedEndpoint = endpoints.get(0);
        String     endpointUrl      = selectedEndpoint.getIdentifier().toExternalForm();

        String ret = endpointUrl;

        String target = org.infogrid.util.http.HTTP.appendArgumentPairToUrl( returnToUrl, "lid-credtype=gpg%20--clearsign" );

        ret = org.infogrid.util.http.HTTP.appendArgumentPairToUrl( ret, "lid-action=sso-approve" );
        ret = org.infogrid.util.http.HTTP.appendArgumentToUrl(     ret, "lid-target", target.toString() );

        return ret;
    }
          ]]></implementsMethod>
          <synonym>http://lid.netmesh.org/sso/2.0</synonym>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/MinimumLid2">
            <name>MinimumLid2</name>
            <username>Minimum LID (version 2)</username>
            <supertype>org.infogrid.lid.model.yadis/XrdsService</supertype>
            <synonym>http://lid.netmesh.org/minimum-lid/2.0</synonym>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/RelyingPartyService">
            <name>RelyingPartyService</name>
            <userdescription>A Yadis Service that is able to accept authentication assertions. More specific subclasses
are provided for specific protocols.</userdescription>
            <supertype>org.infogrid.lid.model.yadis/XrdsService</supertype>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/LidGpgRelyingParty">
            <name>LidGpgRelyingParty</name>
            <username>LID's GPG-based Relying Party Service</username>
            <userdescription>This represents a LID GPG-based Relying Party Service in any version.</userdescription>
            <supertype>org.infogrid.lid.model.lid/RelyingPartyService</supertype>
            <isabstract/>
            <synonym>http://lid.netmesh.org/relying-party</synonym>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/LidGpgRelyingParty2">
            <name>LidGpgRelyingParty2</name>
            <username>LID's GPG-based Relying Party Service (version 2)</username>
            <userdescription>A LID GPG-based Relying Party Service based on the LID GPG SSO service, version 2.</userdescription>
            <supertype>org.infogrid.lid.model.lid/LidGpgRelyingParty</supertype>
            <synonym>http://lid.netmesh.org/relying-party/2.0</synonym>
        </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/Persona">
            <name>Persona</name>
            <username>Persona</username>
            <userdescription>A user at a particular website, aka account.</userdescription>
            <additionalinterface>org.infogrid.lid.LidPersona</additionalinterface>

            <propertytype ID="org.infogrid.lid.model.lid/Persona_Nickname">
                <name>Nickname</name>
                <username>Local nickname</username>
                <userdescription>The user's local nick name, if any.</userdescription>
                <datatype>
                    <StringDataType/>
                </datatype>
                <isoptional/>
            </propertytype>

            <implementsMethod><![CDATA[
    /**
     * Determine the set of remote Identifiers that are also associated with this LidPersona.
     * The Identifier inherited from HasIdentifier is considered the local Identifier.
     *
     * @return the set of remote Identifiers, if any
     */
    public org.infogrid.util.Identifier [] getRemoteIdentifiers()
    {
        org.infogrid.mesh.set.MeshObjectSet remotes = traverse( LidSubjectArea.PERSONA_MAYUSEIDENTITY_WEBRESOURCE.getSource() );
        return remotes.asIdentifiers();
    }

    /**
     * Convenience method to determine whether this LidPersona is identified by the
     * provided Identifier.
     *
     * @param identifier the Identifier to test
     * @return true if this LidPersona is identified by the provided Identifier
     */
    public boolean isIdentifiedBy(
            org.infogrid.util.Identifier identifier )
    {
        if( getIdentifier().equals( identifier )) {
            return true;
        }
        org.infogrid.mesh.set.MeshObjectSet remotes = traverse( LidSubjectArea.PERSONA_MAYUSEIDENTITY_WEBRESOURCE.getSource() );
        if( remotes.contains( identifier )) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Obtain an attribute of the persona.
     *
     * @param key the name of the attribute
     * @return the value of the attribute, or null
     */
    public String getAttribute(
            String key )
    {
        return getAttributes().get( key );
    }

    /**
     * Get the set of keys into the set of attributes.
     *
     * @return the keys into the set of attributes
     */
    public java.util.Set<String> getAttributeKeys()
    {
        return getAttributes().keySet(); // FIXME this can be done more efficiently
    }

    /**
     * Obtain the map of attributes. This breaks encapsulation, but works much better
     * for JSP pages.
     *
     * @return the map of attributes
     */
    public java.util.Map<String,String> getAttributes()
    {
        java.util.Map<String,String> ret = new java.util.HashMap<String,String>();
        ret.put( IDENTIFIER_ATTRIBUTE_NAME, getIdentifier().toExternalForm() );

        StringValue nick = null;
        try {
            nick = getNickname();
        } catch( NotPermittedException ex ) {
            // ignore
        }
        if( nick != null ) {
            ret.put( NICKNAME_ATTRIBUTE_NAME, nick.value() );
        }

        return ret;
    }

    /**
     * Obtain the subset of credential types applicable to this LidPersona.
     *
     * @param set the set of credential types
     * @return the subset of credential types
     */
    public org.infogrid.lid.credential.LidCredentialType [] getApplicableCredentialTypes(
            org.infogrid.lid.credential.LidCredentialType [] set )
    {
        return set; // FIXME for now
    }

    /**
     * Obtain a specific credential.
     *
     * @param type the LidCredentialType for which the credential is to be obtained
     * @return the credential, or null
     */
    public String getCredentialFor(
            org.infogrid.lid.credential.LidCredentialType type )
    {
        return null; // FIXME for now
    }

    ]]></implementsMethod>

            </entitytype>

        <entitytype ID="org.infogrid.lid.model.lid/Session">
            <name>Session</name>
            <username>Session</username>
            <userdescription>A session of a user at a website.</userdescription>
            <additionalinterface>org.infogrid.lid.LidSession</additionalinterface>

            <implementsMethod><![CDATA[
    /**
     * Obtain the client whose session it is.
     *
     * @return the client
     */
    public org.infogrid.util.HasIdentifier getSessionClient()
    {
        try {
            // try local persona first
            MeshObject found = traverse( LidSubjectArea.SESSION_FOR_PERSONA.getSource() ).getSingleMember();
            if( found != null ) {
                return (org.infogrid.lid.model.lid.Persona) found.getTypedFacadeFor( LidSubjectArea.PERSONA );
            }
            // if there is no local persona, use the remote persona
            found = traverse( LidSubjectArea.SESSION_USESIDENTITY_WEBRESOURCE.getSource() ).getSingleMember();
            return found;
        } catch( NotBlessedException ex ) {
            log.error( ex );
            return null;
        }
    }

    /**
     * Obtain the Identifier of the site where the session takes place.
     *
     * @return the site Identifier
     */
    public org.infogrid.util.Identifier getSiteIdentifier()
    {
        MeshObject found = traverse(
                LidSubjectArea.SESSION_ATSITE_WEBRESOURCE.getSource() ).getSingleMember();
        if( found == null ) {
            return null;
        } else {
            return found.getIdentifier();
        }
    }

    /**
     * Obtain the time the LidSession was last authenticated with something stronger than a session cookie.
     *
     * @return the time the LidSession was last authenticated, in System.currentTimeMillis() format
     */
    public long getTimeLastAuthenticated()
    {
        try {
            TimeStampValue lastUsed = getLastAuthenticated();
            if( lastUsed == null ) {
                return -1L;
            }
            return lastUsed.getAsMillis();
        } catch( Throwable t ) {
            log.error( t );
            return -1L;
        }
    }

    /**
     * Obtain the time the LidSession was last used successfully.
     *
     * @return the time the LidSession was last used successfully, in System.currentTimeMillis() format
     */
    public long getTimeLastUsedSuccessfully()
    {
        try {
            TimeStampValue lastUsed = getLastUsedSuccessfully();
            if( lastUsed == null ) {
                return -1L;
            }
            return lastUsed.getAsMillis();
        } catch( Throwable t ) {
            log.error( t );
            return -1L;
        }
    }

    /**
     * Obtain the time when the LidSession will or has become invalid.
     *
     * @return the time the LidSession will or has become invalid, in System.currentTimeMillis() format
     */
    public long getTimeValidUntil()
    {
        try {
            TimeStampValue validUntil = getValidUntil();
            if( validUntil == null ) {
                return -1L;
            }
            return validUntil.getAsMillis();
        } catch( Throwable t ) {
            log.error( t );
            return -1L;
        }
    }

    /**
     * Obtain the session token.
     *
     * @return the session token
     */
    public String getSessionToken()
    {
        String ret = org.infogrid.lid.model.utils.MeshObjectIdentifierSessionTokenConverter.meshObjectIdentifierToToken(
                getIdentifier(),
                getMeshBase().getIdentifier().toExternalForm() + "#" );

        return ret;
    }

    /**
     * Obtain the IP address of the client that created this session.
     *
     * @return the IP address
     */
    public String getCreationClientIp()
    {
        try {
            StringValue ip = getCreatedAtIp();
            if( ip != null ) {
                return ip.value();
            } else {
                return null;
            }
        } catch( Throwable t ) {
            log.error( t );
            return null;
        }
    }

    /**
     * Determine whether this token is still valid.
     *
     * @return true if it is still valid.
     */
    public boolean isStillValid()
    {
        try {
            TimeStampValue until = getValidUntil();
            if( until == null ) {
                return false;
            }
            return until.isInFuture();
        } catch( Throwable t ) {
            log.error( t );
            return false;
        }
    }

    /**
     * Notify the session that it was used successfully.
     */
    public void useSuccessfully()
    {
        try {
            setLastUsedSuccessfully( TimeStampValue.now() );
        } catch( Throwable t ) {
            log.error( t );
        }
    }

    /**
     * Renew the session.
     *
     * @param duration the duration, in milliseconds, from now
     */
    public void renew(
            final long duration )
    {
        getMeshBase().executeNow( new org.infogrid.meshbase.transaction.TransactionAction<Void>() {
                public Void execute(
                        org.infogrid.meshbase.transaction.Transaction tx )
                    throws
                        Throwable
                {
                    setValidUntil( TimeStampValue.nowWithOffset( duration ));
                    return null;
                }
        } );
    }

    /**
     * Invalidate this session.
     */
    public void cancel()
    {
        getMeshBase().executeNow( new org.infogrid.meshbase.transaction.TransactionAction<Void>() {
                public Void execute(
                        org.infogrid.meshbase.transaction.Transaction tx )
                    throws
                        Throwable
                {
                    setValidUntil( TimeStampValue.nowWithOffset( -1L ));
                    setTimeExpires( getValidUntil().getAsMillis() );
                    return null;
                }
        } );
    }

    /**
     * Obtain the key for that was used to create this object by the Factory.
     *
     * @return the key
     */
    public String getFactoryKey()
    {
        return getSessionToken();
    }

    /**
     * Enable a Factory to indicate to the FactoryCreatedObject that it was
     * it that created it.
     *
     * @param factory the Factory that created the FactoryCreatedObject
     */
    public void setFactory(
            org.infogrid.util.Factory<String,org.infogrid.lid.LidSession,org.infogrid.lid.LidSessionManagerArguments> factory )
    {
        throw new UnsupportedOperationException();
    }

    /**
     * Obtain the Factory that created this FactoryCreatedObject. In case of
     * chained factories that delegate to each other, this method is
     * supposed to return the outermost factory invoked by the application programmer.
     *
     * @return the Factory that created the FactoryCreatedObject
     */
    public org.infogrid.util.Factory<String,org.infogrid.lid.LidSession,org.infogrid.lid.LidSessionManagerArguments> getFactory()
    {
        throw new UnsupportedOperationException();
    }

    ]]></implementsMethod>

            <propertytype ID="org.infogrid.lid.model.lid/Session_FirstAuthenticated">
                <name>FirstAuthenticated</name>
                <username>First authenticated at</username>
                <userdescription>The TimeStamp when the user was first authenticated at this site.</userdescription>
                <datatype>
                    <TimeStampDataType/>
                </datatype>
                <defaultvalue code="true">TimeStampValue.now()</defaultvalue>
            </propertytype>

            <propertytype ID="org.infogrid.lid.model.lid/Session_LastAuthenticated">
                <name>LastAuthenticated</name>
                <username>Most recently authenticated at</username>
                <userdescription>The TimeStamp when the user was most recently authenticated at this site.</userdescription>
                <datatype>
                    <TimeStampDataType/>
                </datatype>
                <defaultvalue code="true">TimeStampValue.now()</defaultvalue>
            </propertytype>

            <propertytype ID="org.infogrid.lid.model.lid/Session_LastUsedSuccesfully">
                <name>LastUsedSuccessfully</name>
                <username>Most recently used successfully at</username>
                <userdescription>The TimeStamp when the user was most recently using this session successfully.</userdescription>
                <datatype>
                    <TimeStampDataType/>
                </datatype>
                <isoptional/>
            </propertytype>

            <propertytype ID="org.infogrid.lid.model.lid/Session_ValidUntil">
                <name>ValidUntil</name>
                <username>Valid until</username>
                <userdescription>The TimeStamp when the session has, or will expire and a new authentication is required.</userdescription>
                <datatype>
                    <TimeStampDataType/>
                </datatype>
                <defaultvalue code="true">TimeStampValue.now()</defaultvalue>
            </propertytype>

            <propertytype ID="org.infogrid.lid.model.lid/Session_CreatedAtIp">
                <name>CreatedAtIp</name>
                <username>Created at IP address</username>
                <userdescription>The IP address from where this session was created.</userdescription>
                <datatype>
                    <StringDataType/>
                </datatype>
                <isoptional/>
            </propertytype>
        </entitytype>

        <relationshiptype ID="org.infogrid.lid.model.lid/Session_For_Persona">
            <name>Session_For_Persona</name>
            <username>for</username>
            <userdescription>Identifies the Persona that owns this Session</userdescription>
            <src>
              <e>org.infogrid.lid.model.lid/Session</e>
              <MultiplicityValue>1:1</MultiplicityValue>
            </src>
            <dest>
              <e>org.infogrid.lid.model.lid/Persona</e>
              <MultiplicityValue>0:n</MultiplicityValue>
            </dest>
        </relationshiptype>

        <relationshiptype ID="org.infogrid.lid.model.lid/Persona_MayUseIdentity_WebResource">
            <name>Persona_MayUseIdentity_WebResource</name>
            <username>May use identity</username>
            <userdescription>Enumerates the identities possibly used by Persona</userdescription>
            <src>
              <e>org.infogrid.lid.model.lid/Persona</e>
              <MultiplicityValue>1:n</MultiplicityValue>
            </src>
            <dest>
              <e>org.infogrid.model.Web/WebResource</e>
              <MultiplicityValue>0:n</MultiplicityValue>
            </dest>
        </relationshiptype>

        <relationshiptype ID="org.infogrid.lid.model.lid/Persona_AtSite_WebResource">
            <name>Persona_AtSite_WebResource</name>
            <username>At site</username>
            <userdescription>Identifies the website where the Persona is hosted</userdescription>
            <src>
              <e>org.infogrid.lid.model.lid/Persona</e>
              <MultiplicityValue>1:1</MultiplicityValue>
            </src>
            <dest>
              <e>org.infogrid.model.Web/WebResource</e>
              <MultiplicityValue>0:n</MultiplicityValue>
            </dest>
        </relationshiptype>

        <relationshiptype ID="org.infogrid.lid.model.lid/Session_AtSite_WebResource">
            <name>Session_AtSite_WebResource</name>
            <username>At site</username>
            <userdescription>Identifies the website where the session is taking place</userdescription>
            <src>
              <e>org.infogrid.lid.model.lid/Session</e>
              <MultiplicityValue>1:1</MultiplicityValue>
            </src>
            <dest>
              <e>org.infogrid.model.Web/WebResource</e>
              <MultiplicityValue>0:n</MultiplicityValue>
            </dest>
        </relationshiptype>

        <relationshiptype ID="org.infogrid.lid.model.lid/Session_UsesIdentity_WebResource">
            <name>Session_UsesIdentity_WebResource</name>
            <username>Uses identity</username>
            <userdescription>Identifies the identity used for this session</userdescription>
            <src>
              <e>org.infogrid.lid.model.lid/Session</e>
              <MultiplicityValue>1:1</MultiplicityValue>
            </src>
            <dest>
              <e>org.infogrid.model.Web/WebResource</e>
              <MultiplicityValue>0:n</MultiplicityValue>
            </dest>
        </relationshiptype>
    </subjectarea>
</model>
